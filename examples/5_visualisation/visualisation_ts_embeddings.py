import os
from pathlib import Path

import numpy as np
import pandas as pd
import umap
from matplotlib import pyplot as plt
from sklearn.cluster import DBSCAN
from sklearn.preprocessing import QuantileTransformer

from meta_automl.data_preparation.datasets_loaders.timeseries_dataset_loader import TimeSeriesDatasetsLoader
from meta_automl.data_preparation.file_system import get_project_root
from meta_automl.data_preparation.meta_features_extractors.time_series_meta_features_extractor import \
    TimeSeriesFeaturesExtractor

len_d = {'D1002': 1066, 'D1019': 4089, 'D1032': 2454, 'D1091': 3080, 'D1101': 4211, 'D1104': 4211, 'D1124': 4211,
         'D1162': 4210, 'D1170': 3208, 'D1204': 4211, 'D1219': 4211, 'D1232': 4211, 'D1263': 4211, 'D1270': 4211,
         'D1279': 3712, 'D1317': 4211, 'D1322': 4211, 'D1329': 4211, 'D133': 183, 'D1368': 3080, 'D137': 172,
         'D1378': 4211, 'D1380': 4211, 'D1384': 4211, 'D1411': 1822, 'D1424': 3080, 'D1432': 4211, 'D1433': 4211,
         'D1434': 4211, 'D1438': 4211, 'D1448': 4211, 'D145': 1443, 'D1450': 4209, 'D1459': 4211, 'D1464': 4209,
         'D1475': 4211, 'D1519': 3333, 'D152': 4329, 'D1540': 4211, 'D1551': 4211, 'D1577': 4211, 'D1616': 243,
         'D1651': 375, 'D1679': 505, 'D1693': 249, 'D1706': 314, 'D1712': 190, 'D1735': 179, 'D1740': 255, 'D1847': 295,
         'D1872': 235, 'D1875': 256, 'D1949': 483, 'D1964': 497, 'D1972': 335, 'D1988': 441, 'D2013': 224,
         'D2025': 4211, 'D2027': 2705, 'D2032': 4211, 'D2057': 187, 'D2088': 314, 'D2114': 287, 'D2144': 250,
         'D2162': 197, 'D2214': 285, 'D2221': 645, 'D2262': 3711, 'D2268': 4210, 'D2334': 3584, 'D2343': 3584,
         'D237': 314, 'D2393': 4210, 'D2484': 1318, 'D2486': 1318, 'D250': 312, 'D2534': 3208, 'D2552': 1444,
         'D2600': 3965, 'D261': 286, 'D2648': 4211, 'D2670': 4211, 'D2698': 4211, 'D2717': 4211, 'D2729': 4211,
         'D2797': 4089, 'D282': 221, 'D2850': 3965, 'D2878': 3208, 'D2904': 1318, 'D292': 689, 'D2979': 2705,
         'D2991': 4211, 'D3006': 3585, 'D3012': 4209, 'D3023': 4211, 'D3029': 3208, 'D3043': 4211, 'D3046': 3965,
         'D3050': 3078, 'D3055': 3208, 'D3067': 1822, 'D3082': 4209, 'D3083': 4211, 'D3085': 4211, 'D3094': 3206,
         'D312': 695, 'D3135': 4209, 'D3140': 4211, 'D3167': 3585, 'D3178': 4211, 'D319': 696, 'D3222': 4209,
         'D324': 677, 'D3257': 4211, 'D3266': 4211, 'D3278': 4211, 'D3293': 4211, 'D3298': 4211, 'D3302': 4211,
         'D3322': 4211, 'D3337': 4211, 'D3353': 3585, 'D3364': 2705, 'D3386': 3585, 'D3481': 4211, 'D3498': 4211,
         'D3505': 4209, 'D3520': 3208, 'D3530': 4211, 'D3548': 4211, 'D3569': 3712, 'D3581': 4211, 'D3584': 4211,
         'D3587': 4211, 'D3594': 4211, 'D3599': 1080, 'D3608': 3114, 'D3611': 357, 'D3626': 283, 'D3637': 631,
         'D3678': 252, 'D3681': 311, 'D3686': 251, 'D3691': 172, 'D3697': 497, 'D3721': 293, 'D3737': 373, 'D3745': 835,
         'D376': 691, 'D3779': 314, 'D3787': 251, 'D3792': 242, 'D3816': 503, 'D3819': 1271, 'D3823': 255, 'D3845': 252,
         'D3920': 588, 'D3935': 293, 'D3991': 336, 'D404': 224, 'D4043': 242, 'D4066': 122, 'D4097': 270, 'D4146': 365,
         'D4150': 380, 'D4167': 250, 'D420': 128, 'D4210': 246, 'D4218': 375, 'D435': 190, 'D462': 4210, 'D465': 4210,
         'D535': 2073, 'D543': 2073, 'D548': 4210, 'D56': 970, 'D569': 2954, 'D63': 189, 'D640': 1201, 'D652': 1201,
         'D678': 4211, 'D723': 4211, 'D750': 4211, 'D761': 4211, 'D771': 4211, 'D8': 1013, 'D825': 3712, 'D826': 3712,
         'D828': 3712, 'D852': 3208, 'D856': 3208, 'D870': 4211, 'D902': 4211, 'D910': 4211, 'D939': 4211, 'D954': 3712,
         'D967': 3712, 'D970': 4211, 'D973': 4211, 'H10': 748, 'H103': 748, 'H104': 748, 'H105': 748, 'H106': 748,
         'H108': 748, 'H11': 748, 'H113': 748, 'H116': 748, 'H117': 748, 'H119': 748, 'H12': 748, 'H124': 748,
         'H127': 748, 'H128': 748, 'H131': 748, 'H133': 748, 'H135': 748, 'H137': 748, 'H138': 748, 'H139': 748,
         'H14': 748, 'H140': 748, 'H141': 748, 'H142': 748, 'H144': 748, 'H150': 748, 'H152': 748, 'H154': 748,
         'H156': 748, 'H158': 748, 'H16': 748, 'H160': 748, 'H162': 748, 'H163': 748, 'H164': 748, 'H165': 748,
         'H17': 748, 'H171': 1008, 'H173': 1008, 'H174': 1008, 'H175': 1008, 'H177': 1008, 'H179': 1008, 'H180': 1008,
         'H181': 1008, 'H182': 1008, 'H183': 1008, 'H184': 1008, 'H187': 1008, 'H189': 1008, 'H19': 748, 'H190': 1008,
         'H191': 1008, 'H193': 1008, 'H198': 1008, 'H199': 1008, 'H2': 748, 'H20': 748, 'H200': 1008, 'H205': 1008,
         'H210': 1008, 'H211': 1008, 'H212': 1008, 'H213': 1008, 'H214': 1008, 'H217': 1008, 'H219': 1008, 'H22': 748,
         'H220': 1008, 'H226': 1008, 'H227': 1008, 'H23': 748, 'H230': 1008, 'H231': 1008, 'H235': 1008, 'H236': 1008,
         'H239': 1008, 'H240': 1008, 'H241': 1008, 'H249': 1008, 'H252': 1008, 'H255': 1008, 'H26': 748, 'H266': 1008,
         'H270': 1008, 'H274': 1008, 'H279': 1008, 'H280': 1008, 'H281': 1008, 'H282': 1008, 'H283': 1008, 'H284': 1008,
         'H286': 1008, 'H289': 1008, 'H29': 748, 'H291': 1008, 'H296': 1008, 'H297': 1008, 'H298': 1008, 'H299': 1008,
         'H3': 748, 'H30': 748, 'H300': 1008, 'H306': 1008, 'H309': 1008, 'H310': 1008, 'H311': 1008, 'H312': 1008,
         'H313': 1008, 'H315': 1008, 'H316': 1008, 'H32': 748, 'H320': 1008, 'H322': 1008, 'H325': 1008, 'H326': 1008,
         'H327': 1008, 'H329': 1008, 'H333': 1008, 'H335': 1008, 'H336': 1008, 'H339': 1008, 'H34': 748, 'H340': 1008,
         'H342': 1008, 'H343': 1008, 'H348': 1008, 'H349': 1008, 'H350': 1008, 'H353': 1008, 'H357': 1008, 'H360': 1008,
         'H361': 1008, 'H362': 1008, 'H363': 1008, 'H364': 1008, 'H365': 1008, 'H369': 1008, 'H371': 1008, 'H372': 1008,
         'H378': 1008, 'H380': 1008, 'H382': 1008, 'H383': 1008, 'H386': 1008, 'H387': 1008, 'H388': 1008, 'H389': 1008,
         'H39': 748, 'H390': 1008, 'H391': 1008, 'H393': 1008, 'H394': 1008, 'H398': 1008, 'H399': 1008, 'H4': 748,
         'H401': 1008, 'H402': 1008, 'H404': 1008, 'H408': 1008, 'H409': 1008, 'H410': 1008, 'H412': 1008, 'H414': 1008,
         'H42': 748, 'H43': 748, 'H44': 748, 'H46': 748, 'H47': 748, 'H5': 748, 'H51': 748, 'H53': 748, 'H55': 748,
         'H57': 748, 'H58': 748, 'H59': 748, 'H61': 748, 'H62': 748, 'H63': 748, 'H64': 748, 'H66': 748, 'H68': 748,
         'H70': 748, 'H71': 748, 'H73': 748, 'H74': 748, 'H75': 748, 'H76': 748, 'H78': 748, 'H81': 748, 'H82': 748,
         'H84': 748, 'H86': 748, 'H88': 748, 'H89': 748, 'H9': 748, 'H93': 748, 'H97': 748, 'H98': 748, 'M10641': 252,
         'M1080': 804, 'M11010': 324, 'M11230': 324, 'M11654': 324, 'M11779': 324, 'M11806': 324, 'M12209': 168,
         'M12241': 120, 'M12422': 168, 'M12452': 324, 'M13030': 324, 'M13157': 192, 'M13617': 88, 'M13727': 88,
         'M13796': 232, 'M14148': 177, 'M15150': 123, 'M15443': 380, 'M15510': 248, 'M15559': 736, 'M15902': 335,
         'M16100': 335, 'M16137': 335, 'M1630': 348, 'M16405': 335, 'M16731': 87, 'M16863': 87, 'M16927': 87,
         'M17178': 155, 'M17510': 87, 'M17665': 87, 'M17901': 87, 'M17917': 87, 'M18021': 87, 'M18132': 87,
         'M18267': 87, 'M18489': 97, 'M18550': 97, 'M18663': 122, 'M19181': 87, 'M19216': 87, 'M19553': 87,
         'M20010': 87, 'M20194': 87, 'M20218': 87, 'M20318': 87, 'M20429': 87, 'M2061': 936, 'M20788': 87, 'M2101': 348,
         'M21476': 445, 'M22137': 324, 'M22184': 324, 'M22916': 324, 'M23005': 324, 'M23136': 324, 'M23572': 450,
         'M23842': 352, 'M23923': 468, 'M24186': 242, 'M24396': 450, 'M24648': 352, 'M24684': 352, 'M24777': 381,
         'M24988': 220, 'M25052': 220, 'M25586': 468, 'M25661': 312, 'M26386': 303, 'M26416': 303, 'M26418': 303,
         'M26506': 253, 'M27047': 299, 'M27900': 168, 'M28161': 97, 'M2830': 265, 'M28678': 288, 'M29276': 168,
         'M29608': 300, 'M30319': 229, 'M30428': 251, 'M30459': 250, 'M30623': 251, 'M30696': 251, 'M3075': 205,
         'M31073': 358, 'M31163': 533, 'M31375': 256, 'M31442': 336, 'M31954': 253, 'M31964': 229, 'M32473': 86,
         'M32515': 86, 'M32607': 86, 'M3276': 450, 'M32905': 432, 'M33076': 193, 'M33543': 105, 'M34126': 109,
         'M34214': 131, 'M34318': 169, 'M34347': 100, 'M34499': 101, 'M34536': 101, 'M34564': 100, 'M35054': 193,
         'M35216': 193, 'M35305': 105, 'M35407': 247, 'M35499': 260, 'M35872': 236, 'M35933': 257, 'M36401': 122,
         'M36641': 258, 'M36658': 258, 'M36695': 162, 'M36829': 380, 'M36886': 192, 'M37206': 199, 'M37276': 318,
         'M37366': 192, 'M37635': 252, 'M37647': 324, 'M37980': 324, 'M38216': 324, 'M38297': 324, 'M38361': 324,
         'M38371': 324, 'M384': 187, 'M38662': 217, 'M3876': 370, 'M39015': 250, 'M3909': 193, 'M39253': 231,
         'M3937': 450, 'M39415': 231, 'M3953': 384, 'M39588': 88, 'M39702': 88, 'M39715': 88, 'M39723': 88,
         'M39793': 88, 'M40077': 150, 'M40467': 176, 'M40808': 216, 'M41148': 217, 'M41149': 217, 'M41150': 217,
         'M41172': 203, 'M41657': 313, 'M41691': 495, 'M42102': 198, 'M42327': 265, 'M42494': 94, 'M42518': 101,
         'M42862': 193, 'M43022': 100, 'M43330': 260, 'M4334': 495, 'M43394': 236, 'M43760': 199, 'M43904': 335,
         'M43912': 335, 'M44515': 224, 'M44608': 224, 'M45146': 85, 'M45468': 168, 'M45633': 82, 'M45668': 84,
         'M46411': 174, 'M47220': 85, 'M47277': 85, 'M47556': 85, 'M4845': 372, 'M5151': 370, 'M5216': 370,
         'M5684': 370, 'M5831': 273, 'M5992': 288, 'M6032': 288, 'M6047': 288, 'M6175': 374, 'M6225': 576, 'M6295': 288,
         'M6462': 217, 'M6539': 102, 'M6564': 236, 'M6612': 236, 'M6694': 208, 'M69': 151, 'M690': 348, 'M8051': 87,
         'M8152': 87, 'M8178': 87, 'M8497': 122, 'M8660': 87, 'M9322': 87, 'M9385': 87, 'M9795': 87, 'Q10070': 45,
         'Q10262': 192, 'Q10292': 192, 'Q10466': 126, 'Q10598': 205, 'Q10665': 78, 'Q1069': 47, 'Q10743': 122,
         'Q10800': 74, 'Q10881': 122, 'Q11031': 122, 'Q11433': 128, 'Q11460': 188, 'Q1147': 47, 'Q11652': 40,
         'Q11772': 93, 'Q12090': 123, 'Q12115': 123, 'Q12140': 96, 'Q12172': 91, 'Q1236': 47, 'Q12422': 123,
         'Q12558': 117, 'Q12612': 169, 'Q12672': 130, 'Q12826': 63, 'Q12955': 104, 'Q1299': 106, 'Q13004': 97,
         'Q13011': 101, 'Q13029': 97, 'Q13162': 47, 'Q13196': 33, 'Q13394': 180, 'Q13436': 63, 'Q13698': 47,
         'Q13728': 47, 'Q13880': 47, 'Q13965': 92, 'Q14148': 185, 'Q14792': 136, 'Q14846': 110, 'Q1488': 47,
         'Q15102': 129, 'Q15356': 131, 'Q15369': 124, 'Q15391': 104, 'Q15464': 126, 'Q15498': 110, 'Q15849': 64,
         'Q15924': 74, 'Q15925': 73, 'Q16037': 130, 'Q16228': 130, 'Q16233': 130, 'Q16647': 78, 'Q16713': 78,
         'Q16774': 78, 'Q17039': 78, 'Q17364': 78, 'Q17517': 78, 'Q17664': 78, 'Q1800': 102, 'Q18088': 79, 'Q18248': 79,
         'Q18259': 79, 'Q18316': 79, 'Q18394': 121, 'Q18399': 145, 'Q1848': 66, 'Q18684': 86, 'Q18732': 138,
         'Q18748': 76, 'Q19396': 72, 'Q19419': 111, 'Q19513': 47, 'Q19523': 75, 'Q19528': 131, 'Q19600': 75,
         'Q19791': 47, 'Q19806': 47, 'Q1991': 116, 'Q1993': 124, 'Q20155': 93, 'Q20178': 41, 'Q20231': 123, 'Q2037': 66,
         'Q20437': 40, 'Q20451': 40, 'Q20491': 105, 'Q20560': 91, 'Q20586': 105, 'Q20842': 100, 'Q20975': 104,
         'Q20980': 104, 'Q21004': 129, 'Q2103': 123, 'Q21054': 104, 'Q2112': 109, 'Q2119': 121, 'Q2124': 121,
         'Q21744': 104, 'Q21761': 104, 'Q21774': 104, 'Q21861': 113, 'Q21974': 114, 'Q21987': 114, 'Q22114': 90,
         'Q22152': 114, 'Q22342': 64, 'Q22662': 86, 'Q22876': 69, 'Q22943': 51, 'Q23100': 89, 'Q23137': 84,
         'Q23294': 59, 'Q23308': 59, 'Q23502': 130, 'Q23549': 82, 'Q23694': 50, 'Q23760': 78, 'Q23833': 78,
         'Q2416': 158, 'Q2433': 118, 'Q2443': 158, 'Q2445': 158, 'Q2780': 119, 'Q2784': 91, 'Q2922': 124, 'Q2940': 146,
         'Q2981': 110, 'Q2998': 110, 'Q3223': 146, 'Q3383': 129, 'Q3446': 61, 'Q3483': 121, 'Q3534': 121, 'Q3604': 121,
         'Q3606': 96, 'Q363': 47, 'Q3680': 66, 'Q3701': 146, 'Q3750': 74, 'Q3855': 178, 'Q3938': 126, 'Q4102': 170,
         'Q4308': 126, 'Q4545': 59, 'Q4552': 59, 'Q47': 67, 'Q4713': 192, 'Q4895': 72, 'Q4954': 86, 'Q5049': 78,
         'Q5114': 78, 'Q5278': 71, 'Q5294': 70, 'Q5584': 34, 'Q561': 106, 'Q5641': 75, 'Q5678': 87, 'Q5983': 106,
         'Q6074': 106, 'Q6082': 75, 'Q6138': 106, 'Q6235': 75, 'Q6316': 75, 'Q6355': 75, 'Q6363': 275, 'Q6396': 106,
         'Q6423': 75, 'Q6490': 275, 'Q6631': 75, 'Q6640': 91, 'Q678': 75, 'Q7034': 77, 'Q7199': 103, 'Q7204': 103,
         'Q7256': 95, 'Q7307': 43, 'Q7394': 43, 'Q7425': 43, 'Q7573': 71, 'Q7757': 83, 'Q7963': 41, 'Q8076': 102,
         'Q8191': 105, 'Q8274': 105, 'Q8330': 123, 'Q8345': 123, 'Q8416': 41, 'Q8525': 91, 'Q883': 75, 'Q8889': 111,
         'Q89': 47, 'Q9211': 178, 'Q9687': 114, 'Q9816': 114, 'Q9882': 230, 'Q9977': 45, 'W10': 947, 'W103': 2296,
         'W105': 2296, 'W106': 657, 'W107': 2296, 'W109': 2296, 'W110': 392, 'W111': 392, 'W113': 1057, 'W116': 2296,
         'W117': 862, 'W118': 657, 'W119': 288, 'W121': 2296, 'W122': 2296, 'W123': 2296, 'W124': 2296, 'W129': 392,
         'W13': 734, 'W130': 2296, 'W132': 2296, 'W135': 392, 'W138': 1057, 'W139': 1057, 'W140': 1657, 'W142': 862,
         'W143': 1057, 'W144': 953, 'W145': 953, 'W147': 1657, 'W148': 1657, 'W149': 1657, 'W15': 734, 'W150': 1657,
         'W151': 1657, 'W152': 1657, 'W156': 1657, 'W157': 1057, 'W159': 1657, 'W16': 734, 'W163': 392, 'W165': 1057,
         'W170': 1657, 'W171': 657, 'W177': 1657, 'W18': 734, 'W180': 657, 'W182': 392, 'W183': 1657, 'W185': 1657,
         'W187': 837, 'W190': 837, 'W192': 837, 'W195': 837, 'W196': 837, 'W197': 837, 'W201': 837, 'W202': 837,
         'W204': 1311, 'W207': 947, 'W208': 947, 'W21': 1615, 'W210': 947, 'W211': 947, 'W212': 947, 'W216': 947,
         'W217': 459, 'W219': 591, 'W22': 1620, 'W222': 1100, 'W223': 1220, 'W224': 2609, 'W227': 1615, 'W228': 1620,
         'W229': 1615, 'W23': 1615, 'W230': 1615, 'W234': 1615, 'W235': 1615, 'W236': 1615, 'W237': 1616, 'W24': 1615,
         'W243': 1636, 'W244': 1636, 'W245': 1616, 'W247': 1616, 'W249': 2192, 'W25': 1615, 'W250': 2191, 'W251': 1926,
         'W252': 2191, 'W253': 1887, 'W254': 1324, 'W256': 734, 'W259': 734, 'W261': 734, 'W262': 734, 'W263': 288,
         'W265': 392, 'W266': 392, 'W267': 288, 'W269': 392, 'W270': 953, 'W271': 953, 'W272': 392, 'W276': 392,
         'W277': 1657, 'W28': 1615, 'W280': 1657, 'W282': 837, 'W283': 837, 'W285': 947, 'W287': 947, 'W288': 947,
         'W290': 1100, 'W291': 1220, 'W294': 1220, 'W295': 93, 'W296': 93, 'W297': 93, 'W299': 93, 'W3': 2191,
         'W30': 1615, 'W300': 93, 'W301': 93, 'W302': 93, 'W303': 93, 'W304': 93, 'W305': 93, 'W306': 93, 'W307': 93,
         'W308': 93, 'W313': 93, 'W317': 93, 'W318': 93, 'W319': 93, 'W32': 1616, 'W320': 93, 'W322': 93, 'W324': 93,
         'W325': 93, 'W328': 93, 'W329': 93, 'W331': 93, 'W334': 93, 'W335': 93, 'W336': 93, 'W337': 93, 'W338': 93,
         'W340': 93, 'W342': 93, 'W343': 93, 'W344': 93, 'W345': 93, 'W348': 93, 'W35': 1616, 'W352': 93, 'W353': 93,
         'W358': 93, 'W359': 93, 'W38': 523, 'W39': 1525, 'W4': 2610, 'W40': 1525, 'W43': 1030, 'W44': 1525,
         'W52': 1038, 'W53': 1220, 'W56': 1141, 'W59': 356, 'W60': 2297, 'W61': 1718, 'W63': 2192, 'W64': 2191,
         'W65': 2191, 'W66': 2191, 'W67': 1324, 'W68': 666, 'W69': 517, 'W7': 1616, 'W70': 497, 'W72': 500, 'W75': 734,
         'W76': 260, 'W78': 734, 'W81': 734, 'W82': 1364, 'W84': 497, 'W85': 734, 'W87': 392, 'W89': 1057, 'W9': 1616,
         'W90': 1057, 'W92': 2296, 'W94': 288, 'W95': 288, 'W96': 2296, 'W97': 2296, 'W98': 2296, 'W99': 2296,
         'Y10017': 30, 'Y10059': 30, 'Y10376': 59, 'Y10549': 26, 'Y10560': 26, 'Y10571': 46, 'Y10907': 40, 'Y10908': 40,
         'Y11035': 46, 'Y11041': 46, 'Y1107': 56, 'Y11106': 46, 'Y11116': 46, 'Y11123': 46, 'Y11133': 46, 'Y11253': 23,
         'Y11430': 37, 'Y11572': 28, 'Y11676': 24, 'Y11722': 25, 'Y12073': 26, 'Y1219': 32, 'Y12474': 21, 'Y1273': 36,
         'Y13269': 39, 'Y13527': 22, 'Y13551': 29, 'Y13802': 38, 'Y14055': 46, 'Y1418': 27, 'Y14324': 45, 'Y14689': 56,
         'Y14791': 35, 'Y15039': 21, 'Y15120': 29, 'Y15126': 25, 'Y1519': 27, 'Y1541': 27, 'Y15626': 61, 'Y15903': 60,
         'Y15920': 54, 'Y1596': 27, 'Y16233': 37, 'Y16249': 44, 'Y16315': 55, 'Y16504': 26, 'Y1665': 47, 'Y16856': 56,
         'Y1690': 29, 'Y16941': 25, 'Y1695': 48, 'Y16964': 24, 'Y17142': 23, 'Y173': 61, 'Y17335': 28, 'Y17413': 22,
         'Y1757': 21, 'Y17646': 27, 'Y17760': 35, 'Y17788': 35, 'Y17805': 21, 'Y17916': 35, 'Y1809': 35, 'Y182': 22,
         'Y18453': 21, 'Y18643': 33, 'Y18777': 37, 'Y19028': 36, 'Y191': 41, 'Y19565': 35, 'Y19589': 35, 'Y19631': 21,
         'Y19864': 22, 'Y19942': 21, 'Y20131': 32, 'Y20136': 22, 'Y20212': 24, 'Y20426': 21, 'Y20434': 30, 'Y20443': 22,
         'Y20444': 40, 'Y20522': 36, 'Y2054': 21, 'Y20608': 46, 'Y2063': 35, 'Y20766': 35, 'Y20781': 53, 'Y21101': 29,
         'Y21157': 30, 'Y21158': 29, 'Y21363': 43, 'Y21366': 36, 'Y21377': 28, 'Y2144': 35, 'Y21544': 28, 'Y2164': 21,
         'Y21671': 21, 'Y22101': 35, 'Y2213': 21, 'Y22160': 21, 'Y22165': 21, 'Y22287': 45, 'Y22329': 55, 'Y22346': 56,
         'Y2251': 21, 'Y22519': 32, 'Y22621': 29, 'Y2264': 35, 'Y22714': 25, 'Y22718': 41, 'Y22818': 19, 'Y2505': 23,
         'Y2647': 39, 'Y2738': 25, 'Y2903': 35, 'Y2907': 35, 'Y2971': 28, 'Y3027': 21, 'Y3078': 21, 'Y3207': 53,
         'Y3423': 23, 'Y3523': 45, 'Y3525': 23, 'Y3594': 27, 'Y3668': 56, 'Y3763': 21, 'Y3814': 126, 'Y3836': 57,
         'Y3917': 63, 'Y4275': 33, 'Y4369': 26, 'Y4396': 46, 'Y4408': 26, 'Y4597': 26, 'Y4624': 46, 'Y4640': 46,
         'Y4720': 47, 'Y4805': 47, 'Y4922': 46, 'Y5087': 46, 'Y509': 50, 'Y5212': 66, 'Y5256': 46, 'Y5257': 46,
         'Y5354': 46, 'Y5366': 46, 'Y542': 22, 'Y546': 31, 'Y5467': 46, 'Y5583': 46, 'Y5640': 46, 'Y5657': 26,
         'Y5735': 46, 'Y5899': 46, 'Y6015': 26, 'Y6057': 46, 'Y6106': 32, 'Y611': 26, 'Y6131': 46, 'Y616': 26,
         'Y62': 70, 'Y6269': 46, 'Y6409': 26, 'Y6574': 46, 'Y6617': 46, 'Y6695': 46, 'Y6716': 47, 'Y6752': 46,
         'Y6853': 46, 'Y7126': 46, 'Y7134': 46, 'Y7182': 26, 'Y7268': 46, 'Y7490': 46, 'Y7503': 46, 'Y7642': 46,
         'Y7690': 57, 'Y7692': 57, 'Y7745': 22, 'Y7828': 27, 'Y7942': 47, 'Y7943': 47, 'Y7967': 47, 'Y7983': 35,
         'Y8134': 21, 'Y8307': 35, 'Y8358': 21, 'Y8589': 35, 'Y8728': 35, 'Y8806': 35, 'Y8935': 35, 'Y9245': 41,
         'Y9301': 34, 'Y9328': 21, 'Y9464': 55, 'Y9527': 32, 'Y9591': 32, 'Y983': 26}

tresholds = np.array([100, 200, 300, 500, 700, 1000, 2000, 4000])

len_d_classes = {k: tresholds[np.argmin(np.abs(tresholds - v))] for k, v in len_d.items()}


def main():
    meta_features = pd.read_csv('meta_features_ts.csv', index_col=0)

    # Preprocess meta-features, as KNN does not support NaNs.
    meta_features = meta_features.dropna(axis=1, how='any')
    idx = meta_features.index.values
    meta_features.to_csv('meta_features_ts.csv')
    # Dimension reduction
    dim_reduction = umap.UMAP(n_components=2, min_dist=1)
    X = QuantileTransformer(output_distribution='normal').fit_transform(meta_features)
    X = dim_reduction.fit_transform(X)

    plt.title('UMAP projection of the data')
    colors = {'D': 'blue', 'W': 'orange', 'M': 'red', 'Q': 'black', 'Y': 'purple'}

    for item in colors:
        label = item[0]
        plt.plot([0], [0], 'o', c=colors[item], markersize=3, label=str(label))
    plt.legend()
    plt.scatter(X[:, 0], X[:, 1], c=[colors[i[3]] for i in idx],
                s=[len_d[i[3::]] / 50 if i[3::] in len_d else 10 for i in idx])
    plt.grid()
    plt.show()

    cluster_algo = DBSCAN(eps=0.9)

    # Apply the clustering algorithm to your data
    cluster_labels = cluster_algo.fit_predict(X)
    df_labels = pd.Series(index=idx, data=cluster_labels)
    df_labels.to_csv('labels.csv')


if __name__ == '__main__':
    main()
